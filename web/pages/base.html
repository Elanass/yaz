<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Gastric ADCI - Advanced Decision Confidence Index for Gastric Oncology Surgery">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="apple-touch-icon" href="/static/icons/apple-touch-icon.png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans:wght@400;500;700;900&family=Plus+Jakarta+Sans:wght@400;500;700;800" rel="stylesheet"/>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <!-- Title -->
    <title>{% block title %}Gastric ADCI{% endblock %}</title>
    
    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Plus Jakarta Sans', 'Noto Sans', system-ui, -apple-system, sans-serif;
        }
        
        /* PWA specific styles */
        .pwa-safe-area {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
        
        /* HTMX loading states */
        .htmx-indicator {
            display: none;
        }
        .htmx-request .htmx-indicator {
            display: flex;
        }
        .htmx-request.htmx-indicator {
            display: flex;
        }
        
        /* Smooth transitions */
        .htmx-settling * {
            transition: all 200ms ease-in;
        }
        
        /* Offline indicator */
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #ef4444;
            color: white;
            text-align: center;
            padding: 8px;
            z-index: 100;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }
        .offline-indicator.show {
            transform: translateY(0);
        }
    </style>
    
    {% block extra_head %}{% endblock %}
</head>
<body class="font-sans bg-neutral-50 flex flex-col min-h-screen pwa-safe-area" 
      x-data="{ 
          activeCategory: 'journal', 
          currentPage: '{{ current_page or "dashboard" }}',
          sidebarOpen: false,
          isOnline: navigator.onLine 
      }"
      x-init="
          window.addEventListener('online', () => isOnline = true);
          window.addEventListener('offline', () => isOnline = false);
      ">
    
    <!-- Offline Indicator -->
    <div class="offline-indicator" :class="{ 'show': !isOnline }">
        <span class="text-sm font-medium">You are offline. Some features may be limited.</span>
    </div>
    
    <!-- Header Component -->
    {% include "components/header.html" %}
    
    <!-- Search Bar Component -->
    {% include "components/search_bar.html" %}
    
    <!-- Main Content Area -->
    <main id="main-content" class="flex-1 mb-20">
        {% block content %}{% endblock %}
    </main>
    
    <!-- Bottom Navigation Component -->
    {% include "components/bottom_nav.html" %}
    
    <!-- PWA Install Prompt (Hidden by default) -->
    <div id="pwa-install-prompt" class="fixed bottom-24 left-4 right-4 bg-blue-600 text-white p-4 rounded-lg shadow-lg z-50 hidden">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="font-medium">Install Gastric ADCI</h3>
                <p class="text-sm opacity-90">Add to home screen for better experience</p>
            </div>
            <div class="flex space-x-2">
                <button id="pwa-install-btn" class="bg-white text-blue-600 px-3 py-1 rounded text-sm font-medium">
                    Install
                </button>
                <button id="pwa-dismiss-btn" class="text-white/80 hover:text-white">
                    Ã—
                </button>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://unpkg.com/htmx.org@1.9.6/dist/htmx.min.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.6/dist/ext/response-targets.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.6/dist/ext/loading-states.js"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    
    <!-- PWA and Offline Support -->
    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
        
        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('pwa-install-prompt').classList.remove('hidden');
        });
        
        document.getElementById('pwa-install-btn')?.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                document.getElementById('pwa-install-prompt').classList.add('hidden');
            }
        });
        
        document.getElementById('pwa-dismiss-btn')?.addEventListener('click', () => {
            document.getElementById('pwa-install-prompt').classList.add('hidden');
        });
        
        // HTMX Configuration
        document.body.addEventListener('htmx:configRequest', (event) => {
            // Add CSRF token if available
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            if (csrfToken) {
                event.detail.headers['X-CSRF-Token'] = csrfToken;
            }
        });
        
        // Handle HTMX errors
        document.body.addEventListener('htmx:responseError', (event) => {
            console.error('HTMX Error:', event.detail);
            // Show user-friendly error message
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white p-3 rounded-md z-50';
            errorDiv.textContent = 'Something went wrong. Please try again.';
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        });
        
        // Performance monitoring
        window.addEventListener('load', () => {
            // Log performance metrics
            const perfData = performance.getEntriesByType('navigation')[0];
            if (perfData) {
                console.log('Page Load Time:', perfData.loadEventEnd - perfData.loadEventStart, 'ms');
            }
        });
    </script>
    
    {% block extra_scripts %}{% endblock %}
</body>
</html>
