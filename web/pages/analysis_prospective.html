{% extends "base.html" %}

{% block title %}Prospective Analysis{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="display-5 mb-4">Prospective Statistical Analysis</h1>
            <p class="lead">
                Build predictive models for patient outcomes using Random Forest and access the Reinforcement Learning engine.
            </p>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title">Random Forest Model</h3>
                </div>
                <div class="card-body">
                    <p>
                        Random Forest is an ensemble learning method that combines multiple decision trees to improve prediction accuracy and prevent overfitting.
                    </p>
                    
                    <form hx-post="/api/v1/analysis/prospective/random-forest" 
                          hx-encoding="multipart/form-data"
                          hx-target="#random-forest-results"
                          hx-indicator="#rf-loading">
                          
                        <div class="mb-3">
                            <label for="rf-file" class="form-label">Upload CSV Dataset</label>
                            <input type="file" class="form-control" id="rf-file" name="file" accept=".csv" required>
                            <div class="form-text">CSV file with patient data including outcome and feature columns</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="rf-outcome-column" class="form-label">Outcome Column</label>
                            <input type="text" class="form-control" id="rf-outcome-column" name="outcome_column" placeholder="e.g., outcome" required>
                            <div class="form-text">Column name for outcome to predict</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="rf-feature-columns" class="form-label">Feature Columns</label>
                            <input type="text" class="form-control" id="rf-feature-columns" name="feature_columns" placeholder="e.g., age,stage,treatment" required>
                            <div class="form-text">Comma-separated list of feature column names</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="rf-n-estimators" class="form-label">Number of Trees</label>
                            <input type="number" class="form-control" id="rf-n-estimators" name="n_estimators" value="100" min="10" max="1000">
                            <div class="form-text">Number of trees in the forest (default: 100)</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="rf-test-size" class="form-label">Test Set Size</label>
                            <input type="number" class="form-control" id="rf-test-size" name="test_size" value="0.2" min="0.1" max="0.5" step="0.1">
                            <div class="form-text">Proportion of data to use for testing (default: 0.2)</div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            Train Random Forest Model
                            <span class="spinner-border spinner-border-sm d-none" id="rf-loading" role="status" aria-hidden="true"></span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h3 class="card-title">Patient Outcome Prediction</h3>
                </div>
                <div class="card-body">
                    <p>
                        Predict outcomes for individual patients using trained models.
                    </p>
                    
                    <form hx-post="/api/v1/analysis/prospective/predict" 
                          hx-target="#prediction-results"
                          hx-indicator="#predict-loading">
                          
                        <div class="mb-3">
                            <label for="predict-model-type" class="form-label">Model Type</label>
                            <select class="form-select" id="predict-model-type" name="model_type">
                                <option value="random_forest">Random Forest</option>
                                <option value="reinforcement_learning">Reinforcement Learning (Experimental)</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="predict-patient-id" class="form-label">Patient ID</label>
                            <input type="text" class="form-control" id="predict-patient-id" name="patient_data.id" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="predict-age" class="form-label">Age</label>
                            <input type="number" class="form-control" id="predict-age" name="patient_data.age" min="18" max="100" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="predict-tumor-stage" class="form-label">Tumor Stage</label>
                            <select class="form-select" id="predict-tumor-stage" name="patient_data.tumor_stage" required>
                                <option value="T1N0M0">T1N0M0</option>
                                <option value="T2N0M0">T2N0M0</option>
                                <option value="T3N0M0">T3N0M0</option>
                                <option value="T4N0M0">T4N0M0</option>
                                <option value="T1N1M0">T1N1M0</option>
                                <option value="T2N1M0">T2N1M0</option>
                                <option value="T3N1M0">T3N1M0</option>
                                <option value="T4N1M0">T4N1M0</option>
                                <option value="T*N*M1">T*N*M1</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="predict-comorbidities" class="form-label">Comorbidities</label>
                            <input type="text" class="form-control" id="predict-comorbidities" name="patient_data.comorbidities" placeholder="e.g., hypertension,diabetes">
                            <div class="form-text">Comma-separated list of comorbidities</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="predict-performance" class="form-label">Performance Status (ECOG)</label>
                            <select class="form-select" id="predict-performance" name="patient_data.performance_status" required>
                                <option value="0">0 - Fully active</option>
                                <option value="1">1 - Restricted but ambulatory</option>
                                <option value="2">2 - Ambulatory, self-care capable, >50% waking hours up</option>
                                <option value="3">3 - Limited self-care, >50% waking hours in bed</option>
                                <option value="4">4 - Completely disabled</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="btn btn-success">
                            Predict Outcome
                            <span class="spinner-border spinner-border-sm d-none" id="predict-loading" role="status" aria-hidden="true"></span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <div id="random-forest-results" class="mb-4"></div>
            <div id="prediction-results" class="mb-4"></div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h3 class="card-title">About Prospective Analysis</h3>
                </div>
                <div class="card-body">
                    <p>
                        Prospective analysis uses predictive modeling to forecast patient outcomes based on current clinical data.
                        This approach is valuable for clinical decision support and personalized treatment planning.
                    </p>
                    
                    <h5>Random Forest Benefits:</h5>
                    <ul>
                        <li>Handles complex non-linear relationships</li>
                        <li>Provides feature importance rankings</li>
                        <li>Robust to outliers and noise</li>
                        <li>Reduces overfitting through ensemble approach</li>
                    </ul>
                    
                    <h5>Reinforcement Learning (Experimental):</h5>
                    <ul>
                        <li>Learns optimal treatment strategies from outcomes</li>
                        <li>Adapts to changing patient characteristics</li>
                        <li>Balances exploration of new approaches with exploitation of known effective treatments</li>
                    </ul>
                    
                    <div class="alert alert-warning">
                        <strong>Note:</strong> These predictions should be used as a supplement to, not a replacement for, clinical judgment.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
