<!-- 
Surgery Analysis Dashboard

This component provides a comprehensive interface for surgical case analysis
including patient data input, risk assessment, protocol recommendations,
and outcome predictions with evidence-based decision support.

The interface follows WCAG 2.1 AA accessibility standards and is optimized
for healthcare professional workflows with offline-first PWA capabilities.
-->

<div class="surgery-analyzer-dashboard" 
     hx-ext="client-side-templates"
     data-tpl="mustache">
  <div class="dashboard-header">
    <h1>Integrated Surgery Analysis</h1>
    <p class="dashboard-description">Comprehensive surgical case analysis with risk assessment, protocol optimization, and outcome prediction.</p>
  </div>

  <div class="case-input-section card">
    <h2>Surgery Case Input</h2>
    <form id="surgery-case-form" hx-post="/api/v1/surgery/analyze" hx-target="#analysis-results" hx-indicator="#form-indicator">
      <!-- Patient Identifiers -->
      <div class="form-group">
        <label for="case_id">Case ID</label>
        <input type="text" name="case_id" id="case_id" required>
      </div>
      
      <div class="form-group">
        <label for="patient_id">Patient ID</label>
        <input type="text" name="patient_id" id="patient_id" required>
      </div>
      
      <!-- Surgery Type Selection -->
      <div class="form-group">
        <label for="surgery_type">Surgery Type</label>
        <select name="surgery_type" id="surgery_type" required 
                hx-get="/api/v1/surgery/protocols/" 
                hx-target="#protocol-info"
                hx-include="this">
          <option value="">Select Surgery Type</option>
          <option value="gastric_flot">Gastric Surgery (FLOT)</option>
          <option value="colorectal_eras">Colorectal Surgery (ERAS)</option>
          <option value="hepatobiliary">Hepatobiliary Surgery</option>
          <option value="emergency">Emergency Surgery</option>
          <option value="general">General Surgery</option>
        </select>
      </div>
      
      <!-- Patient Demographics -->
      <div class="form-row">
        <div class="form-group">
          <label for="age">Age</label>
          <input type="number" name="age" id="age" min="0" max="120" required>
        </div>
        
        <div class="form-group">
          <label for="gender">Gender</label>
          <select name="gender" id="gender" required>
            <option value="male">Male</option>
            <option value="female">Female</option>
            <option value="other">Other</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="bmi">BMI</label>
          <input type="number" name="bmi" id="bmi" step="0.1" min="10" max="80">
        </div>
      </div>
      
      <!-- Medical History -->
      <div class="form-group">
        <label>Comorbidities</label>
        <div class="checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" name="comorbidities" value="hypertension"> Hypertension
          </label>
          <label class="checkbox-label">
            <input type="checkbox" name="comorbidities" value="diabetes"> Diabetes
          </label>
          <label class="checkbox-label">
            <input type="checkbox" name="comorbidities" value="coronary_artery_disease"> Coronary Artery Disease
          </label>
          <label class="checkbox-label">
            <input type="checkbox" name="comorbidities" value="copd"> COPD
          </label>
          <label class="checkbox-label">
            <input type="checkbox" name="comorbidities" value="chronic_kidney_disease"> Chronic Kidney Disease
          </label>
        </div>
      </div>
      
      <!-- Clinical Data -->
      <div class="section-header">
        <h3>Clinical Data</h3>
        <button type="button" class="btn-toggle" data-target="clinical-data-section">Show/Hide</button>
      </div>
      
      <div id="clinical-data-section" class="collapsible-section">
        <div class="form-row">
          <div class="form-group">
            <label for="asa_score">ASA Score</label>
            <select name="asa_score" id="asa_score">
              <option value="">Select</option>
              <option value="1">ASA I</option>
              <option value="2">ASA II</option>
              <option value="3">ASA III</option>
              <option value="4">ASA IV</option>
              <option value="5">ASA V</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="urgency">Urgency</label>
            <select name="urgency" id="urgency">
              <option value="elective">Elective</option>
              <option value="urgent">Urgent</option>
              <option value="emergency">Emergency</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label for="lab_values">Lab Values (JSON format)</label>
          <textarea name="lab_values" id="lab_values" rows="3" placeholder='{"albumin": 3.5, "creatinine": 1.2, "hemoglobin": 13.5}'></textarea>
          <small class="form-text">Enter lab values in JSON format: {"name": value}</small>
        </div>
      </div>
      
      <!-- Surgery-Specific Data -->
      <div id="dynamic-fields" class="dynamic-fields">
        <!-- Fields will be dynamically loaded based on surgery type -->
      </div>
      
      <!-- FLOT-Specific Section - shown only for gastric_flot -->
      <div id="flot-section" class="surgery-specific-section" style="display: none;">
        <div class="section-header">
          <h3>FLOT Protocol Data</h3>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="tumor_stage">Tumor Stage</label>
            <input type="text" name="tumor_stage" id="tumor_stage" placeholder="e.g., T3N1M0">
          </div>
          
          <div class="form-group">
            <label for="flot_cycles_completed">FLOT Cycles Completed</label>
            <input type="number" name="flot_cycles_completed" id="flot_cycles_completed" min="0" max="8">
          </div>
        </div>
        
        <div class="form-group">
          <label for="response_to_neoadjuvant">Response to Neoadjuvant Therapy</label>
          <select name="response_to_neoadjuvant" id="response_to_neoadjuvant">
            <option value="">Select</option>
            <option value="complete">Complete Response</option>
            <option value="partial">Partial Response</option>
            <option value="stable">Stable Disease</option>
            <option value="progression">Disease Progression</option>
          </select>
        </div>
      </div>
      
      <!-- Protocol Information Section -->
      <div id="protocol-info" class="protocol-info-section">
        <!-- Protocol information will be loaded here -->
      </div>
      
      <div class="form-actions">
        <button type="submit" class="btn-primary">Analyze Surgery Case</button>
        <button type="reset" class="btn-secondary">Reset Form</button>
        <div id="form-indicator" class="htmx-indicator">
          <div class="spinner"></div> Analyzing case...
        </div>
      </div>
    </form>
  </div>
  
  <div id="analysis-results" class="analysis-results-section">
    <!-- Analysis results will be rendered here -->
    <template id="analysis-template">
      <div class="results-header">
        <h2>Analysis Results</h2>
        <div class="results-meta">
          <span class="case-id">Case: {{case_id}}</span>
          <span class="timestamp">{{timestamp}}</span>
        </div>
      </div>
      
      <div class="results-grid">
        <!-- Risk Assessment Section -->
        <div class="result-card risk-assessment">
          <h3>Risk Assessment</h3>
          <div class="risk-overview">
            <div class="risk-level {{analysis.risk_assessment.risk_category}}">
              {{analysis.risk_assessment.risk_category}}
            </div>
            <div class="risk-score">
              <span class="score-value">{{analysis.risk_assessment.overall_risk_score}}</span>
              <span class="score-label">Risk Score</span>
            </div>
          </div>
          
          <h4>Risk Components</h4>
          <div class="risk-components">
            {{#analysis.risk_assessment.risk_components}}
            <div class="risk-component">
              <div class="component-name">{{name}}</div>
              <div class="component-value">
                <div class="progress-bar" style="width: {{value}}%"></div>
              </div>
            </div>
            {{/analysis.risk_assessment.risk_components}}
          </div>
          
          <h4>Mitigation Strategies</h4>
          <ul class="mitigation-list">
            {{#analysis.risk_assessment.mitigation_strategies}}
            <li>{{.}}</li>
            {{/analysis.risk_assessment.mitigation_strategies}}
          </ul>
        </div>
        
        <!-- Protocol Recommendations Section -->
        <div class="result-card protocol-recommendations">
          <h3>Protocol Recommendations</h3>
          <div class="protocol-overview">
            <div class="protocol-name">{{analysis.protocol_recommendations.recommended_protocol}}</div>
          </div>
          
          <h4>Protocol Elements</h4>
          <ul class="protocol-elements">
            {{#analysis.protocol_recommendations.protocol_elements}}
            <li>{{.}}</li>
            {{/analysis.protocol_recommendations.protocol_elements}}
          </ul>
          
          {{#analysis.protocol_recommendations.contraindications.length}}
          <h4>Contraindications</h4>
          <ul class="contraindications-list alert">
            {{#analysis.protocol_recommendations.contraindications}}
            <li>{{.}}</li>
            {{/analysis.protocol_recommendations.contraindications}}
          </ul>
          {{/analysis.protocol_recommendations.contraindications.length}}
        </div>
        
        <!-- Outcome Predictions Section -->
        <div class="result-card outcome-predictions">
          <h3>Outcome Predictions</h3>
          
          <div class="outcomes-grid">
            <div class="outcome mortality">
              <h4>Mortality Risk</h4>
              <div class="prediction-value {{analysis.outcome_predictions.mortality.prediction}}">
                {{analysis.outcome_predictions.mortality.prediction}}
              </div>
              <div class="confidence">
                Confidence: {{analysis.outcome_predictions.mortality.confidence}}
              </div>
            </div>
            
            <div class="outcome morbidity">
              <h4>Morbidity Risk</h4>
              <div class="prediction-value {{analysis.outcome_predictions.morbidity.prediction}}">
                {{analysis.outcome_predictions.morbidity.prediction}}
              </div>
              <div class="confidence">
                Confidence: {{analysis.outcome_predictions.morbidity.confidence}}
              </div>
            </div>
            
            <div class="outcome los">
              <h4>Length of Stay</h4>
              <div class="prediction-value">
                {{analysis.outcome_predictions.los.prediction}} days
              </div>
              <div class="confidence">
                Confidence: {{analysis.outcome_predictions.los.confidence}}
              </div>
            </div>
            
            <div class="outcome readmission">
              <h4>Readmission Risk</h4>
              <div class="prediction-value {{analysis.outcome_predictions.readmission.prediction}}">
                {{analysis.outcome_predictions.readmission.prediction}}
              </div>
              <div class="confidence">
                Confidence: {{analysis.outcome_predictions.readmission.confidence}}
              </div>
            </div>
          </div>
          
          <h4>Key Risk Factors</h4>
          <ul class="risk-factors-list">
            {{#analysis.outcome_predictions.mortality.risk_factors}}
            <li>{{.}}</li>
            {{/analysis.outcome_predictions.mortality.risk_factors}}
          </ul>
        </div>
        
        <!-- Quality Metrics Section -->
        <div class="result-card quality-metrics">
          <h3>Quality Metrics</h3>
          
          <div class="metrics-grid">
            {{#analysis.quality_indicators}}
            <div class="metric">
              <div class="metric-name">{{name}}</div>
              <div class="metric-value">{{value}}</div>
              <div class="metric-gauge">
                <div class="gauge-fill" style="width: {{value_percent}}%"></div>
              </div>
            </div>
            {{/analysis.quality_indicators}}
          </div>
        </div>
        
        <!-- Decision Support Section -->
        <div class="result-card decision-support">
          <h3>Decision Support</h3>
          
          {{#analysis.decision_support.alerts.length}}
          <div class="alerts-section">
            <h4>Alerts</h4>
            <ul class="alerts-list">
              {{#analysis.decision_support.alerts}}
              <li class="alert">{{.}}</li>
              {{/analysis.decision_support.alerts}}
            </ul>
          </div>
          {{/analysis.decision_support.alerts.length}}
          
          <h4>Recommendations</h4>
          <ul class="recommendations-list">
            {{#analysis.decision_support.recommendations}}
            <li>{{.}}</li>
            {{/analysis.decision_support.recommendations}}
          </ul>
          
          <h4>Next Steps</h4>
          <ol class="next-steps-list">
            {{#analysis.decision_support.next_steps}}
            <li>{{.}}</li>
            {{/analysis.decision_support.next_steps}}
          </ol>
        </div>
        
        <!-- Impact Metrics Section -->
        <div class="result-card impact-metrics">
          <h3>Impact Metrics</h3>
          
          <div class="impact-metrics-grid">
            <div class="impact-metric">
              <h4>Cost Savings</h4>
              <div class="metric-value">{{impact_metrics.estimated_cost_savings.savings_percentage}}%</div>
              <div class="metric-details">
                Baseline: ${{impact_metrics.estimated_cost_savings.baseline_cost}}
                <br>
                Optimized: ${{impact_metrics.estimated_cost_savings.optimized_cost}}
              </div>
            </div>
            
            <div class="impact-metric">
              <h4>Complication Reduction</h4>
              <div class="metric-value">{{impact_metrics.estimated_complication_reduction.reduction_percentage}}%</div>
              <div class="metric-details">
                Baseline rate: {{impact_metrics.estimated_complication_reduction.baseline_complication_rate}}
                <br>
                Expected rate: {{impact_metrics.estimated_complication_reduction.expected_complication_rate}}
              </div>
            </div>
            
            <div class="impact-metric">
              <h4>Quality Improvement</h4>
              <div class="metric-value">+{{impact_metrics.estimate_quality_improvement.quality_score_improvement}}</div>
              <div class="metric-details">
                <strong>Key metrics improved:</strong>
                <ul>
                  {{#impact_metrics.estimate_quality_improvement.key_metrics_improved}}
                  <li>{{.}}</li>
                  {{/impact_metrics.estimate_quality_improvement.key_metrics_improved}}
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="results-footer">
        <div class="confidence-indicator">
          Analysis Confidence: <span class="confidence-value">{{analysis.confidence_score}}</span>
        </div>
        <div class="actions">
          <button class="btn-primary" onclick="printAnalysis()">Print Report</button>
          <button class="btn-secondary" onclick="exportAnalysis()">Export (PDF)</button>
          <button class="btn-secondary" onclick="saveToEMR()">Save to EMR</button>
        </div>
      </div>
    </template>
  </div>
</div>

<script>
  // Show/hide surgery-specific fields based on surgery type
  document.getElementById('surgery_type').addEventListener('change', function() {
    // Hide all surgery-specific sections
    document.querySelectorAll('.surgery-specific-section').forEach(section => {
      section.style.display = 'none';
    });
    
    // Show the section for the selected surgery type
    if (this.value === 'gastric_flot') {
      document.getElementById('flot-section').style.display = 'block';
    }
    
    // Dynamic field loading based on surgery type
    loadDynamicFields(this.value);
  });
  
  // Toggle collapsible sections
  document.querySelectorAll('.btn-toggle').forEach(button => {
    button.addEventListener('click', function() {
      const targetId = this.getAttribute('data-target');
      const targetElement = document.getElementById(targetId);
      
      if (targetElement.classList.contains('collapsed')) {
        targetElement.classList.remove('collapsed');
        this.textContent = 'Hide';
      } else {
        targetElement.classList.add('collapsed');
        this.textContent = 'Show';
      }
    });
  });
  
  // Handle form submission with JSON conversion for complex fields
  document.getElementById('surgery-case-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Convert form data to JSON
    const formData = new FormData(this);
    const jsonData = {};
    
    for (const [key, value] of formData.entries()) {
      // Handle arrays (like comorbidities checkboxes)
      if (key.endsWith('[]') || formData.getAll(key).length > 1) {
        const cleanKey = key.replace('[]', '');
        if (!jsonData[cleanKey]) {
          jsonData[cleanKey] = formData.getAll(key);
        }
      } 
      // Handle JSON fields
      else if (key === 'lab_values' && value) {
        try {
          jsonData[key] = JSON.parse(value);
        } catch (err) {
          alert('Invalid JSON format in Lab Values field');
          return;
        }
      }
      // Regular fields
      else {
        jsonData[key] = value;
      }
    }
    
    // Submit using HTMX
    htmx.trigger(this, 'submit', { json: jsonData });
  });
  
  // Load dynamic fields based on surgery type
  function loadDynamicFields(surgeryType) {
    const dynamicFieldsContainer = document.getElementById('dynamic-fields');
    
    // Clear existing fields
    dynamicFieldsContainer.innerHTML = '';
    
    // Load fields based on surgery type
    if (surgeryType === 'gastric_flot') {
      // Fields are already in the FLOT section
    } else if (surgeryType === 'colorectal_eras') {
      dynamicFieldsContainer.innerHTML = `
        <div class="section-header">
          <h3>Colorectal Surgery Data</h3>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="tumor_location">Tumor Location</label>
            <select name="tumor_location" id="tumor_location">
              <option value="">Select</option>
              <option value="right_colon">Right Colon</option>
              <option value="transverse_colon">Transverse Colon</option>
              <option value="left_colon">Left Colon</option>
              <option value="sigmoid">Sigmoid</option>
              <option value="rectum">Rectum</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="neoadjuvant_therapy">Neoadjuvant Therapy</label>
            <select name="neoadjuvant_therapy" id="neoadjuvant_therapy">
              <option value="none">None</option>
              <option value="chemotherapy">Chemotherapy</option>
              <option value="chemoradiation">Chemoradiation</option>
            </select>
          </div>
        </div>
      `;
    } else if (surgeryType === 'hepatobiliary') {
      dynamicFieldsContainer.innerHTML = `
        <div class="section-header">
          <h3>Hepatobiliary Surgery Data</h3>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="liver_function">Liver Function</label>
            <select name="liver_function" id="liver_function">
              <option value="normal">Normal</option>
              <option value="mild_dysfunction">Mild Dysfunction</option>
              <option value="moderate_dysfunction">Moderate Dysfunction</option>
              <option value="severe_dysfunction">Severe Dysfunction</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="tumor_number">Number of Tumors</label>
            <input type="number" name="tumor_number" id="tumor_number" min="1" max="20">
          </div>
          
          <div class="form-group">
            <label for="largest_tumor_size">Largest Tumor Size (cm)</label>
            <input type="number" name="largest_tumor_size" id="largest_tumor_size" step="0.1" min="0.1">
          </div>
        </div>
      `;
    }
  }
  
  // Print analysis report
  function printAnalysis() {
    window.print();
  }
  
  // Export analysis as PDF
  function exportAnalysis() {
    alert('Exporting as PDF... Feature in development.');
    // Implementation will use PDF.js or similar
  }
  
  // Save to EMR
  function saveToEMR() {
    alert('Saving to EMR... Feature in development.');
    // Implementation will use FHIR or hospital-specific integration
  }
  
  // Handle offline capability
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('/service-worker.js').then(
        function(registration) {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }, 
        function(err) {
          console.log('ServiceWorker registration failed: ', err);
        }
      );
    });
  }
  
  // Store form data in localStorage for offline recovery
  document.getElementById('surgery-case-form').addEventListener('input', function() {
    const formData = new FormData(this);
    const formDataObj = {};
    
    formData.forEach((value, key) => {
      formDataObj[key] = value;
    });
    
    localStorage.setItem('surgery_form_data', JSON.stringify(formDataObj));
  });
  
  // Restore form data from localStorage if available
  document.addEventListener('DOMContentLoaded', function() {
    const savedData = localStorage.getItem('surgery_form_data');
    
    if (savedData) {
      try {
        const formDataObj = JSON.parse(savedData);
        const form = document.getElementById('surgery-case-form');
        
        Object.keys(formDataObj).forEach(key => {
          const input = form.elements[key];
          if (input) {
            input.value = formDataObj[key];
          }
        });
        
        // Trigger change event for surgery type to load dynamic fields
        const surgeryTypeSelect = document.getElementById('surgery_type');
        if (surgeryTypeSelect.value) {
          const event = new Event('change');
          surgeryTypeSelect.dispatchEvent(event);
        }
      } catch (e) {
        console.error('Error restoring form data:', e);
      }
    }
  });
</script>

{% block extra_scripts %}
  <script src="/static/js/surgery_analyzer.js"></script>
{% endblock %}

<style>
  /* Surgery Analyzer Dashboard Styles */
  .surgery-analyzer-dashboard {
    --primary-color: #1976d2;
    --secondary-color: #455a64;
    --success-color: #4caf50;
    --warning-color: #ff9800;
    --danger-color: #f44336;
    --light-gray: #f5f5f5;
    --border-color: #e0e0e0;
    --text-color: #333;
    --text-secondary: #757575;
    --border-radius: 4px;
    --box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
    color: var(--text-color);
  }
  
  /* Dashboard Header */
  .dashboard-header {
    margin-bottom: 30px;
    text-align: center;
  }
  
  .dashboard-header h1 {
    color: var(--primary-color);
    font-size: 2rem;
    margin-bottom: 10px;
  }
  
  .dashboard-description {
    color: var(--text-secondary);
    font-size: 1.1rem;
  }
  
  /* Card Layout */
  .card {
    background: #fff;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    padding: 20px;
    margin-bottom: 30px;
  }
  
  /* Form Styling */
  .form-group {
    margin-bottom: 20px;
  }
  
  .form-row {
    display: flex;
    flex-wrap: wrap;
    margin: 0 -10px 20px;
  }
  
  .form-row .form-group {
    flex: 1;
    padding: 0 10px;
    min-width: 200px;
  }
  
  label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
  }
  
  input[type="text"],
  input[type="number"],
  select,
  textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    font-size: 1rem;
    transition: border-color 0.2s;
  }
  
  input:focus,
  select:focus,
  textarea:focus {
    border-color: var(--primary-color);
    outline: none;
  }
  
  /* Checkbox Styling */
  .checkbox-group {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  
  .checkbox-label {
    display: flex;
    align-items: center;
    cursor: pointer;
    margin-right: 15px;
  }
  
  .checkbox-label input {
    margin-right: 6px;
  }
  
  /* Section Headers */
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 5px;
    border-bottom: 1px solid var(--border-color);
  }
  
  .section-header h3 {
    margin: 0;
    color: var(--secondary-color);
  }
  
  /* Collapsible Sections */
  .collapsible-section {
    transition: max-height 0.3s ease-out;
    overflow: hidden;
  }
  
  .collapsible-section.collapsed {
    max-height: 0;
  }
  
  /* Buttons */
  .btn-primary,
  .btn-secondary,
  .btn-toggle {
    padding: 10px 15px;
    border-radius: var(--border-radius);
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.2s, transform 0.1s;
    border: none;
  }
  
  .btn-primary {
    background-color: var(--primary-color);
    color: white;
  }
  
  .btn-secondary {
    background-color: var(--light-gray);
    color: var(--text-color);
  }
  
  .btn-toggle {
    background-color: transparent;
    color: var(--primary-color);
    padding: 5px 10px;
    font-size: 0.9rem;
  }
  
  .btn-primary:hover,
  .btn-secondary:hover {
    transform: translateY(-2px);
  }
  
  .btn-primary:active,
  .btn-secondary:active {
    transform: translateY(0);
  }
  
  /* Form Actions */
  .form-actions {
    display: flex;
    gap: 10px;
    margin-top: 30px;
    align-items: center;
  }
  
  /* HTMX Indicator */
  .htmx-indicator {
    display: none;
    align-items: center;
    margin-left: 15px;
    color: var(--text-secondary);
  }
  
  .htmx-request .htmx-indicator {
    display: flex;
  }
  
  .spinner {
    width: 20px;
    height: 20px;
    border: 3px solid rgba(0, 0, 0, 0.1);
    border-radius: 50%;
    border-top-color: var(--primary-color);
    animation: spin 1s ease-in-out infinite;
    margin-right: 10px;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  /* Analysis Results Section */
  .analysis-results-section {
    margin-top: 40px;
  }
  
  .results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }
  
  .result-card {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    padding: 20px;
  }
  
  .result-card h3 {
    color: var(--primary-color);
    margin-top: 0;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color);
  }
  
  .result-card h4 {
    color: var(--secondary-color);
    margin: 15px 0 10px;
  }
  
  /* Risk Assessment Styling */
  .risk-overview {
    display: flex;
    align-items: center;
    justify-content: space-around;
    margin: 15px 0;
  }
  
  .risk-level {
    padding: 10px 15px;
    border-radius: 20px;
    text-transform: uppercase;
    font-weight: bold;
    letter-spacing: 1px;
  }
  
  .risk-level.LOW {
    background-color: #e8f5e9;
    color: #2e7d32;
  }
  
  .risk-level.MODERATE {
    background-color: #fff8e1;
    color: #f57f17;
  }
  
  .risk-level.HIGH {
    background-color: #ffebee;
    color: #c62828;
  }
  
  .risk-level.CRITICAL {
    background-color: #7f0000;
    color: white;
  }
  
  .risk-score {
    text-align: center;
  }
  
  .score-value {
    font-size: 1.8rem;
    font-weight: bold;
    display: block;
  }
  
  .score-label {
    font-size: 0.9rem;
    color: var(--text-secondary);
  }
  
  .risk-component {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
  }
  
  .component-name {
    flex: 1;
  }
  
  .component-value {
    width: 100px;
    height: 10px;
    background-color: var(--light-gray);
    border-radius: 5px;
    overflow: hidden;
  }
  
  .progress-bar {
    height: 100%;
    background-color: var(--primary-color);
  }
  
  /* Protocol Recommendations Styling */
  .protocol-name {
    font-size: 1.2rem;
    font-weight: bold;
    color: var(--primary-color);
    text-align: center;
    margin: 15px 0;
    padding: 10px;
    border: 1px solid var(--primary-color);
    border-radius: var(--border-radius);
  }
  
  /* Alerts Styling */
  .alert {
    color: var(--danger-color);
    font-weight: 500;
  }
  
  .alerts-list li {
    margin-bottom: 8px;
    padding: 8px;
    background-color: #ffebee;
    border-radius: var(--border-radius);
    border-left: 4px solid var(--danger-color);
  }
  
  /* Outcome Predictions Styling */
  .outcomes-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
  }
  
  .outcome {
    text-align: center;
    padding: 10px;
    border-radius: var(--border-radius);
    background-color: var(--light-gray);
  }
  
  .prediction-value {
    font-size: 1.3rem;
    font-weight: bold;
    margin: 10px 0;
  }
  
  .prediction-value.standard_risk,
  .prediction-value.low_risk {
    color: #2e7d32;
  }
  
  .prediction-value.moderate_risk {
    color: #f57f17;
  }
  
  .prediction-value.high_risk {
    color: #c62828;
  }
  
  .confidence {
    font-size: 0.9rem;
    color: var(--text-secondary);
  }
  
  /* Quality Metrics Styling */
  .metrics-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
  }
  
  .metric {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    margin-bottom: 10px;
  }
  
  .metric-name {
    flex: 1;
    min-width: 150px;
  }
  
  .metric-value {
    width: 50px;
    text-align: right;
    font-weight: bold;
  }
  
  .metric-gauge {
    flex: 1;
    height: 8px;
    background-color: var(--light-gray);
    border-radius: 4px;
    overflow: hidden;
    margin-left: 10px;
    min-width: 100px;
  }
  
  .gauge-fill {
    height: 100%;
    background-color: var(--primary-color);
  }
  
  /* Impact Metrics Styling */
  .impact-metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
  }
  
  .impact-metric {
    text-align: center;
    padding: 15px;
    border-radius: var(--border-radius);
    background-color: #e3f2fd;
  }
  
  .impact-metric h4 {
    margin-top: 0;
  }
  
  .impact-metric .metric-value {
    font-size: 1.5rem;
    color: var(--primary-color);
    margin: 10px 0;
    width: 100%;
    text-align: center;
  }
  
  .metric-details {
    font-size: 0.9rem;
    color: var(--text-secondary);
    text-align: left;
  }
  
  /* Results Footer */
  .results-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid var(--border-color);
  }
  
  .confidence-indicator {
    font-size: 1.1rem;
  }
  
  .confidence-value {
    font-weight: bold;
    color: var(--primary-color);
  }
  
  .results-footer .actions {
    display: flex;
    gap: 10px;
  }
  
  /* Responsive Adjustments */
  @media (max-width: 768px) {
    .results-grid {
      grid-template-columns: 1fr;
    }
    
    .outcomes-grid {
      grid-template-columns: 1fr;
    }
    
    .impact-metrics-grid {
      grid-template-columns: 1fr;
    }
    
    .results-footer {
      flex-direction: column;
      gap: 15px;
    }
    
    .form-row .form-group {
      flex: 100%;
    }
  }
  
  /* Print Styles */
  @media print {
    .case-input-section,
    .btn-toggle,
    .btn-secondary,
    .actions {
      display: none;
    }
    
    .surgery-analyzer-dashboard {
      padding: 0;
    }
    
    .result-card {
      break-inside: avoid;
      page-break-inside: avoid;
      box-shadow: none;
      border: 1px solid #ddd;
    }
    
    .results-grid {
      display: block;
    }
    
    .result-card + .result-card {
      margin-top: 20px;
    }
  }
</style>
