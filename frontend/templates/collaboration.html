{% extends "layout.html" %}

{% block title %}ADCI Platform - Collaboration & Telemedicine{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/css/pwa.css">
{% endblock %}

{% block content %}
<div class="collab-container">
    <div class="collab-header">
        <h1>Telemedicine & Collaboration</h1>
        <div class="session-info">
            <div id="session-status" class="session-badge">
                <i class="fas fa-circle"></i> Not Connected
            </div>
            <div class="session-controls">
                <button id="btn-new-session" class="btn btn-primary">
                    <i class="fas fa-plus"></i> New Session
                </button>
                <button id="btn-join-session" class="btn btn-outline">
                    <i class="fas fa-sign-in-alt"></i> Join Session
                </button>
                <button id="btn-end-session" class="btn btn-danger" disabled>
                    <i class="fas fa-times"></i> End Session
                </button>
            </div>
        </div>
    </div>
    
    <div class="collab-main">
        <div class="participants-panel">
            <h3>Participants</h3>
            <div id="participants-list" class="participants-list">
                <div class="no-participants">No participants yet</div>
            </div>
            <div class="self-controls">
                <h4>Your Controls</h4>
                <div class="media-controls">
                    <button id="btn-toggle-video" class="btn btn-sm btn-tool" disabled>
                        <i class="fas fa-video"></i>
                    </button>
                    <button id="btn-toggle-audio" class="btn btn-sm btn-tool" disabled>
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button id="btn-toggle-screen" class="btn btn-sm btn-tool" disabled>
                        <i class="fas fa-desktop"></i>
                    </button>
                </div>
                <div class="video-preview">
                    <video id="local-video" autoplay muted playsinline></video>
                </div>
            </div>
        </div>
        
        <div class="collab-content">
            <div class="content-tabs">
                <button class="tab-btn active" data-tab="video-tab">
                    <i class="fas fa-video"></i> Video Conference
                </button>
                <button class="tab-btn" data-tab="dicom-tab">
                    <i class="fas fa-x-ray"></i> DICOM Viewer
                </button>
                <button class="tab-btn" data-tab="whiteboard-tab">
                    <i class="fas fa-edit"></i> Whiteboard
                </button>
                <button class="tab-btn" data-tab="notes-tab">
                    <i class="fas fa-file-medical-alt"></i> Clinical Notes
                </button>
            </div>
            
            <div class="tab-content">
                <!-- Video Conference Tab -->
                <div id="video-tab" class="tab-pane active">
                    <div class="video-grid" id="video-grid"></div>
                </div>
                
                <!-- DICOM Viewer Tab -->
                <div id="dicom-tab" class="tab-pane">
                    <div class="shared-dicom-container">
                        <div class="dicom-controls">
                            <button id="btn-load-dicom-collab" class="btn btn-sm btn-primary">
                                <i class="fas fa-upload"></i> Load DICOM
                            </button>
                            <button id="btn-sync-view" class="btn btn-sm btn-primary" disabled>
                                <i class="fas fa-sync-alt"></i> Sync View
                            </button>
                            <div class="viewing-status">
                                <span id="sync-status">Not Synced</span>
                            </div>
                        </div>
                        <div id="shared-cornerstone-viewport" class="shared-cornerstone-viewport"></div>
                    </div>
                </div>
                
                <!-- Whiteboard Tab -->
                <div id="whiteboard-tab" class="tab-pane">
                    <div class="whiteboard-container">
                        <div class="whiteboard-tools">
                            <button class="tool-btn" data-tool="pen">
                                <i class="fas fa-pen"></i>
                            </button>
                            <button class="tool-btn" data-tool="eraser">
                                <i class="fas fa-eraser"></i>
                            </button>
                            <button class="tool-btn" data-tool="text">
                                <i class="fas fa-font"></i>
                            </button>
                            <button class="tool-btn" data-tool="shape">
                                <i class="fas fa-shapes"></i>
                            </button>
                            <input type="color" id="color-picker" value="#ff0000">
                            <select id="stroke-width">
                                <option value="1">1px</option>
                                <option value="3" selected>3px</option>
                                <option value="5">5px</option>
                                <option value="8">8px</option>
                            </select>
                            <button id="btn-clear-whiteboard" class="btn btn-sm btn-danger">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                        </div>
                        <canvas id="whiteboard-canvas"></canvas>
                    </div>
                </div>
                
                <!-- Clinical Notes Tab -->
                <div id="notes-tab" class="tab-pane">
                    <div class="notes-container">
                        <div class="notes-toolbar">
                            <button id="btn-save-notes" class="btn btn-sm btn-primary">
                                <i class="fas fa-save"></i> Save
                            </button>
                            <button id="btn-export-notes" class="btn btn-sm btn-secondary">
                                <i class="fas fa-file-export"></i> Export
                            </button>
                            <div class="notes-status">
                                <span id="notes-sync-status">Not Synced</span>
                            </div>
                        </div>
                        <div class="notes-editor">
                            <div class="editor-toolbar">
                                <button data-command="bold" class="editor-btn"><i class="fas fa-bold"></i></button>
                                <button data-command="italic" class="editor-btn"><i class="fas fa-italic"></i></button>
                                <button data-command="underline" class="editor-btn"><i class="fas fa-underline"></i></button>
                                <button data-command="insertUnorderedList" class="editor-btn"><i class="fas fa-list-ul"></i></button>
                                <button data-command="insertOrderedList" class="editor-btn"><i class="fas fa-list-ol"></i></button>
                                <button data-command="createLink" class="editor-btn"><i class="fas fa-link"></i></button>
                                <select id="heading-select" class="editor-select">
                                    <option value="">Paragraph</option>
                                    <option value="h1">Heading 1</option>
                                    <option value="h2">Heading 2</option>
                                    <option value="h3">Heading 3</option>
                                </select>
                                <button id="btn-insert-template" class="editor-btn"><i class="fas fa-clipboard-list"></i></button>
                            </div>
                            <div id="notes-editor-content" class="notes-editor-content" contenteditable="true">
                                <h2>Clinical Consultation Notes</h2>
                                <p>Enter your notes here...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chat-panel">
            <h3>Chat</h3>
            <div id="chat-messages" class="chat-messages"></div>
            <div class="chat-input">
                <input type="text" id="chat-input" placeholder="Type a message...">
                <button id="btn-send-message" class="btn btn-primary btn-sm">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div class="collab-footer">
        <div class="connection-info">
            <div id="encryption-status" class="encryption-badge">
                <i class="fas fa-lock"></i> End-to-End Encrypted
            </div>
            <div id="network-quality" class="network-badge good">
                <i class="fas fa-signal"></i> Network: Good
            </div>
        </div>
        <div class="compliance-badge">
            <i class="fas fa-shield-alt"></i> HIPAA/GDPR Compliant
        </div>
    </div>
</div>

<!-- New Session Modal -->
<div class="modal fade" id="new-session-modal" tabindex="-1" aria-labelledby="newSessionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newSessionModalLabel">Create New Session</h5>
                <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="session-name" class="form-label">Session Name:</label>
                    <input type="text" id="session-name" class="form-control" placeholder="Gastric Case Discussion">
                </div>
                <div class="mb-3">
                    <label for="session-type" class="form-label">Session Type:</label>
                    <select id="session-type" class="form-select">
                        <option value="consultation">Clinical Consultation</option>
                        <option value="tumor-board">Tumor Board</option>
                        <option value="surgical-planning">Surgical Planning</option>
                        <option value="followup">Post-Op Follow-up</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Session Options:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="option-record" checked>
                        <label class="form-check-label" for="option-record">
                            Record session (compliant storage)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="option-transcribe">
                        <label class="form-check-label" for="option-transcribe">
                            Enable transcription
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="option-secure" checked>
                        <label class="form-check-label" for="option-secure">
                            End-to-end encryption
                        </label>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="session-participants" class="form-label">Invite Participants:</label>
                    <div class="input-group">
                        <input type="email" id="session-participants" class="form-control" placeholder="Enter email address">
                        <button id="btn-add-participant" class="btn btn-outline-secondary">Add</button>
                    </div>
                    <div id="participants-preview" class="mt-2"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button id="btn-create-session" type="button" class="btn btn-primary">Create Session</button>
            </div>
        </div>
    </div>
</div>

<!-- Join Session Modal -->
<div class="modal fade" id="join-session-modal" tabindex="-1" aria-labelledby="joinSessionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="joinSessionModalLabel">Join Session</h5>
                <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="join-code" class="form-label">Session Code:</label>
                    <input type="text" id="join-code" class="form-control" placeholder="Enter 6-digit code">
                </div>
                <div class="mb-3">
                    <label for="display-name" class="form-label">Your Display Name:</label>
                    <input type="text" id="display-name" class="form-control" placeholder="Dr. Smith">
                </div>
                <div class="mb-3">
                    <label class="form-label">Join Options:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="join-video" checked>
                        <label class="form-check-label" for="join-video">
                            Enable video
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="join-audio" checked>
                        <label class="form-check-label" for="join-audio">
                            Enable audio
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button id="btn-do-join-session" type="button" class="btn btn-primary">Join Session</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="module" src="/static/js/pwa/webrtc-collab.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class from all tabs
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.remove('active');
                });
                
                // Add active class to clicked tab
                this.classList.add('active');
                document.getElementById(this.getAttribute('data-tab')).classList.add('active');
            });
        });
        
        // Open modal handlers
        document.getElementById('btn-new-session').addEventListener('click', function() {
            $('#new-session-modal').modal('show');
        });
        
        document.getElementById('btn-join-session').addEventListener('click', function() {
            $('#join-session-modal').modal('show');
        });
        
        // Editor toolbar functionality (basic demo)
        document.querySelectorAll('.editor-btn').forEach(button => {
            button.addEventListener('click', function() {
                const command = this.getAttribute('data-command');
                if (command === 'createLink') {
                    const url = prompt('Enter the link URL:');
                    if (url) document.execCommand(command, false, url);
                } else {
                    document.execCommand(command, false, null);
                }
            });
        });
        
        // Heading select
        document.getElementById('heading-select').addEventListener('change', function() {
            if (this.value) {
                document.execCommand('formatBlock', false, this.value);
            }
        });
        
        // Template insert
        document.getElementById('btn-insert-template').addEventListener('click', function() {
            const template = `
                <h2>Clinical Assessment</h2>
                <p><strong>Patient:</strong> [Patient Name]</p>
                <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                <h3>Current Status</h3>
                <ul>
                    <li>Chief Complaint: </li>
                    <li>Relevant History: </li>
                    <li>Recent Imaging: </li>
                </ul>
                <h3>Assessment</h3>
                <p></p>
                <h3>Plan</h3>
                <ol>
                    <li></li>
                    <li></li>
                    <li></li>
                </ol>
            `;
            
            document.getElementById('notes-editor-content').innerHTML = template;
        });
    });
</script>
{% endblock %}
