{% extends "layout.html" %}

{% block title %}ADCI Platform - AR Visualization{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/css/pwa.css">
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/DRACOLoader.js"></script>
{% endblock %}

{% block content %}
<div class="ar-container">
    <div class="ar-header">
        <h1>AR Visualization</h1>
        <div class="ar-toolbar">
            <div class="model-selector">
                <label for="model-select">Select Model:</label>
                <select id="model-select" class="select">
                    <option value="stomach-normal">Normal Stomach</option>
                    <option value="stomach-cancer">Gastric Cancer</option>
                    <option value="gastrectomy-partial">Partial Gastrectomy</option>
                    <option value="gastrectomy-total">Total Gastrectomy</option>
                    <option value="lymph-nodes">Lymph Node Stations</option>
                    <option value="patient-specific" disabled>Patient-Specific Model (Requires DICOM)</option>
                </select>
            </div>
            <div class="view-controls">
                <button id="btn-toggle-labels" class="btn btn-sm btn-tool">
                    <i class="fas fa-tags"></i> Labels
                </button>
                <button id="btn-toggle-xray" class="btn btn-sm btn-tool">
                    <i class="fas fa-x-ray"></i> X-Ray View
                </button>
                <button id="btn-toggle-ar" class="btn btn-sm btn-primary">
                    <i class="fas fa-vr-cardboard"></i> Start AR
                </button>
            </div>
        </div>
    </div>
    
    <div class="ar-main">
        <div class="ar-sidebar">
            <div class="sidebar-section">
                <h3>Structure Visibility</h3>
                <div class="structure-toggles">
                    <div class="structure-toggle">
                        <input type="checkbox" id="structure-stomach" checked>
                        <label for="structure-stomach">Stomach</label>
                    </div>
                    <div class="structure-toggle">
                        <input type="checkbox" id="structure-esophagus" checked>
                        <label for="structure-esophagus">Esophagus</label>
                    </div>
                    <div class="structure-toggle">
                        <input type="checkbox" id="structure-duodenum" checked>
                        <label for="structure-duodenum">Duodenum</label>
                    </div>
                    <div class="structure-toggle">
                        <input type="checkbox" id="structure-vessels" checked>
                        <label for="structure-vessels">Blood Vessels</label>
                    </div>
                    <div class="structure-toggle">
                        <input type="checkbox" id="structure-tumor">
                        <label for="structure-tumor">Tumor</label>
                    </div>
                    <div class="structure-toggle">
                        <input type="checkbox" id="structure-lymph">
                        <label for="structure-lymph">Lymph Nodes</label>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3>Surgical Approaches</h3>
                <div class="approach-toggles">
                    <div class="approach-toggle">
                        <input type="radio" name="approach" id="approach-none" checked>
                        <label for="approach-none">None</label>
                    </div>
                    <div class="approach-toggle">
                        <input type="radio" name="approach" id="approach-distal">
                        <label for="approach-distal">Distal Gastrectomy</label>
                    </div>
                    <div class="approach-toggle">
                        <input type="radio" name="approach" id="approach-total">
                        <label for="approach-total">Total Gastrectomy</label>
                    </div>
                    <div class="approach-toggle">
                        <input type="radio" name="approach" id="approach-proximal">
                        <label for="approach-proximal">Proximal Gastrectomy</label>
                    </div>
                    <div class="approach-toggle">
                        <input type="radio" name="approach" id="approach-wedge">
                        <label for="approach-wedge">Wedge Resection</label>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3>D2 Lymphadenectomy</h3>
                <div class="lymph-stations">
                    <button class="lymph-station-btn" data-station="1">Station 1</button>
                    <button class="lymph-station-btn" data-station="2">Station 2</button>
                    <button class="lymph-station-btn" data-station="3">Station 3</button>
                    <button class="lymph-station-btn" data-station="4">Station 4</button>
                    <button class="lymph-station-btn" data-station="5">Station 5</button>
                    <button class="lymph-station-btn" data-station="6">Station 6</button>
                    <button class="lymph-station-btn" data-station="7">Station 7</button>
                    <button class="lymph-station-btn" data-station="8">Station 8</button>
                    <button class="lymph-station-btn" data-station="9">Station 9</button>
                    <button class="lymph-station-btn" data-station="10">Station 10</button>
                    <button class="lymph-station-btn" data-station="11">Station 11</button>
                    <button class="lymph-station-btn" data-station="12">Station 12</button>
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3>Animation</h3>
                <div class="animation-controls">
                    <button id="btn-animate-gastrectomy" class="btn btn-sm btn-primary">
                        <i class="fas fa-play"></i> Animate Procedure
                    </button>
                    <div class="animation-speed">
                        <label for="animation-speed">Speed:</label>
                        <input type="range" id="animation-speed" min="0.5" max="2" step="0.1" value="1">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="ar-viewer-container">
            <!-- 3D Viewer -->
            <div id="model-viewer" class="model-viewer"></div>
            
            <!-- AR Session (initially hidden) -->
            <div id="ar-session" class="ar-session" style="display: none;">
                <!-- AR content will be here -->
            </div>
            
            <!-- Controls Overlay -->
            <div class="viewer-controls">
                <button id="btn-reset-view" class="viewer-btn">
                    <i class="fas fa-home"></i>
                </button>
                <button id="btn-zoom-in" class="viewer-btn">
                    <i class="fas fa-search-plus"></i>
                </button>
                <button id="btn-zoom-out" class="viewer-btn">
                    <i class="fas fa-search-minus"></i>
                </button>
                <button id="btn-rotate" class="viewer-btn">
                    <i class="fas fa-sync"></i>
                </button>
                <button id="btn-screenshot" class="viewer-btn">
                    <i class="fas fa-camera"></i>
                </button>
            </div>
        </div>
        
        <div class="ar-info-panel">
            <div class="panel-tabs">
                <button class="panel-tab active" data-tab="anatomy-tab">Anatomy</button>
                <button class="panel-tab" data-tab="surgical-tab">Surgical</button>
                <button class="panel-tab" data-tab="patient-tab">Patient</button>
            </div>
            
            <div class="panel-content">
                <!-- Anatomy Tab -->
                <div id="anatomy-tab" class="tab-content active">
                    <h3 id="structure-name">Stomach</h3>
                    <p id="structure-description">
                        The stomach is a muscular, hollow organ in the gastrointestinal tract that functions as an important digestive organ. It is located between the esophagus and the small intestine.
                    </p>
                    <div class="key-facts">
                        <div class="fact">
                            <span class="fact-label">Blood Supply:</span>
                            <span class="fact-value">Celiac artery via left gastric, splenic, and hepatic arteries</span>
                        </div>
                        <div class="fact">
                            <span class="fact-label">Lymphatic Drainage:</span>
                            <span class="fact-value">Gastric, celiac, and porta hepatis nodes</span>
                        </div>
                        <div class="fact">
                            <span class="fact-label">Innervation:</span>
                            <span class="fact-value">Vagus nerve and sympathetic celiac plexus</span>
                        </div>
                    </div>
                </div>
                
                <!-- Surgical Tab -->
                <div id="surgical-tab" class="tab-content">
                    <h3 id="approach-name">No Approach Selected</h3>
                    <p id="approach-description">
                        Select a surgical approach from the sidebar to view details.
                    </p>
                    <div class="key-facts">
                        <div class="fact">
                            <span class="fact-label">Indications:</span>
                            <span class="fact-value" id="approach-indications">-</span>
                        </div>
                        <div class="fact">
                            <span class="fact-label">Margins:</span>
                            <span class="fact-value" id="approach-margins">-</span>
                        </div>
                        <div class="fact">
                            <span class="fact-label">Lymphadenectomy:</span>
                            <span class="fact-value" id="approach-lymphadenectomy">-</span>
                        </div>
                        <div class="fact">
                            <span class="fact-label">Complications:</span>
                            <span class="fact-value" id="approach-complications">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Patient Tab -->
                <div id="patient-tab" class="tab-content">
                    <div class="patient-notice">
                        <i class="fas fa-user-circle"></i>
                        <p>No patient-specific model loaded</p>
                        <button id="btn-load-patient-data" class="btn btn-sm btn-primary">
                            Load Patient Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="ar-footer">
        <div class="webxr-status">
            <span id="webxr-support-status">Checking WebXR support...</span>
        </div>
        <div class="export-options">
            <button id="btn-export-model" class="btn btn-sm btn-secondary">
                <i class="fas fa-file-export"></i> Export Model
            </button>
            <button id="btn-share-ar" class="btn btn-sm btn-secondary">
                <i class="fas fa-share-alt"></i> Share View
            </button>
        </div>
    </div>
</div>

<!-- Patient Data Modal -->
<div class="modal fade" id="patient-data-modal" tabindex="-1" aria-labelledby="patientDataModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="patientDataModalLabel">Load Patient Data</h5>
                <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="patient-search" class="form-label">Search Patient:</label>
                    <input type="text" id="patient-search" class="form-control" placeholder="Enter patient ID or name">
                </div>
                <div class="mb-3">
                    <label class="form-label">Or select from recent:</label>
                    <div class="recent-patients">
                        <div class="patient-card" data-id="P12345">
                            <div class="patient-initials">JS</div>
                            <div class="patient-info">
                                <div class="patient-name">John S.</div>
                                <div class="patient-details">57M - Gastric Adenocarcinoma</div>
                            </div>
                        </div>
                        <div class="patient-card" data-id="P23456">
                            <div class="patient-initials">MT</div>
                            <div class="patient-info">
                                <div class="patient-name">Mary T.</div>
                                <div class="patient-details">63F - GIST</div>
                            </div>
                        </div>
                        <div class="patient-card" data-id="P34567">
                            <div class="patient-initials">RJ</div>
                            <div class="patient-info">
                                <div class="patient-name">Robert J.</div>
                                <div class="patient-details">71M - Gastric Carcinoma</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Import from DICOM:</label>
                    <button id="btn-import-from-dicom" class="btn btn-primary w-100">
                        <i class="fas fa-file-medical"></i> Import from DICOM
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button id="btn-load-selected-patient" type="button" class="btn btn-primary" disabled>Load Patient</button>
            </div>
        </div>
    </div>
</div>

<!-- WebXR not supported warning -->
<div id="webxr-warning" class="webxr-warning" style="display: none;">
    <div class="warning-content">
        <i class="fas fa-exclamation-triangle"></i>
        <h3>WebXR Not Supported</h3>
        <p>Your browser doesn't support WebXR, which is required for AR visualization.</p>
        <p>You can still use the 3D model viewer, but AR features will not be available.</p>
        <button id="btn-dismiss-warning" class="btn btn-primary">Continue with 3D Only</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="module" src="/static/js/pwa/ar-visualization.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Tab switching in info panel
        document.querySelectorAll('.panel-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active class from all tabs
                document.querySelectorAll('.panel-tab').forEach(t => {
                    t.classList.remove('active');
                });
                document.querySelectorAll('.tab-content').forEach(c => {
                    c.classList.remove('active');
                });
                
                // Add active class to clicked tab
                this.classList.add('active');
                document.getElementById(this.getAttribute('data-tab')).classList.add('active');
            });
        });
        
        // Patient data modal
        document.getElementById('btn-load-patient-data').addEventListener('click', function() {
            $('#patient-data-modal').modal('show');
        });
        
        // Patient card selection
        document.querySelectorAll('.patient-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.patient-card').forEach(c => {
                    c.classList.remove('selected');
                });
                this.classList.add('selected');
                document.getElementById('btn-load-selected-patient').removeAttribute('disabled');
            });
        });
        
        // Check WebXR support and show warning if needed
        if (!navigator.xr) {
            document.getElementById('webxr-support-status').innerHTML = 
                '<i class="fas fa-times-circle"></i> WebXR not supported';
            document.getElementById('webxr-support-status').classList.add('not-supported');
            document.getElementById('btn-toggle-ar').setAttribute('disabled', 'disabled');
            
            setTimeout(() => {
                document.getElementById('webxr-warning').style.display = 'flex';
            }, 1000);
        } else {
            navigator.xr.isSessionSupported('immersive-ar')
                .then(supported => {
                    if (supported) {
                        document.getElementById('webxr-support-status').innerHTML = 
                            '<i class="fas fa-check-circle"></i> WebXR supported';
                        document.getElementById('webxr-support-status').classList.add('supported');
                    } else {
                        document.getElementById('webxr-support-status').innerHTML = 
                            '<i class="fas fa-times-circle"></i> AR not supported';
                        document.getElementById('webxr-support-status').classList.add('not-supported');
                        document.getElementById('btn-toggle-ar').setAttribute('disabled', 'disabled');
                        
                        setTimeout(() => {
                            document.getElementById('webxr-warning').style.display = 'flex';
                        }, 1000);
                    }
                });
        }
        
        // Dismiss WebXR warning
        document.getElementById('btn-dismiss-warning').addEventListener('click', function() {
            document.getElementById('webxr-warning').style.display = 'none';
        });
    });
</script>
{% endblock %}
