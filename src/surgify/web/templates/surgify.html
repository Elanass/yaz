{% extends "base.html" %}

{% block title %}Surgify - Clinical Research Interface{% endblock %}

{% block extra_head %}
<link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin />
<link rel="stylesheet" as="style" onload="this.rel='stylesheet'" href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans:wght@400;500;700;900&family=Plus+Jakarta+Sans:wght@400;500;700;800" />
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
{% endblock %}

{% block content %}
<div class="relative flex w-full min-h-screen flex-col bg-neutral-50 justify-between group/design-root overflow-x-hidden" style='font-family: "Plus Jakarta Sans", "Noto Sans", sans-serif;'>
  <div>
    <div class="flex items-center bg-neutral-50 p-4 pb-2 justify-between">
      <div class="text-[#141414] flex size-12 shrink-0 items-center" data-icon="List" data-size="24px" data-weight="regular">
        <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
          <path d="M224,128a8,8,0,0,1-8,8H40a8,8,0,0,1,0-16H216A8,8,0,0,1,224,128ZM40,72H216a8,8,0,0,0,0-16H40a8,8,0,0,0,0,16ZM216,184H40a8,8,0,0,0,0,16H216a8,8,0,0,0,0-16Z"></path>
        </svg>
      </div>
      <h2 class="text-[#141414] text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center">Surgify</h2>
      <div class="flex items-center gap-3">
        <!-- Auth Logo -->
        <div class="flex items-center justify-center w-8 h-8 bg-blue-600 rounded-full">
          <svg xmlns="http://www.w3.org/2000/svg" width="16px" height="16px" fill="white" viewBox="0 0 256 256">
            <path d="M208,80H176V56a48,48,0,0,0-96,0V80H48A16,16,0,0,0,32,96V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V96A16,16,0,0,0,208,80ZM96,56a32,32,0,0,1,64,0V80H96ZM208,208H48V96H208V208Z"></path>
          </svg>
        </div>
        <!-- Light Toggle -->
        <button id="theme-toggle" class="flex items-center justify-center w-8 h-8 rounded-full hover:bg-gray-200 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor" viewBox="0 0 256 256">
            <path d="M233.54,142.23a8,8,0,0,0-8-2,88.08,88.08,0,0,1-109.8-109.8,8,8,0,0,0-10-10,104.84,104.84,0,0,0-52.91,37A104,104,0,0,0,136,224a103.09,103.09,0,0,0,62.52-20.88,104.84,104.84,0,0,0,37-52.91A8,8,0,0,0,233.54,142.23Z"></path>
          </svg>
        </button>
        <!-- User Profile -->
        <button class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-8 w-8 bg-transparent text-[#141414] hover:bg-gray-200 transition-colors">
          <div class="text-[#141414]" data-icon="User" data-size="20px" data-weight="regular">
            <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor" viewBox="0 0 256 256">
              <path d="M230.92,212c-15.23-26.33-38.7-45.21-66.09-54.16a72,72,0,1,0-73.66,0C63.78,166.78,40.31,185.66,25.08,212a8,8,0,1,0,13.85,8c18.84-32.56,52.14-52,89.07-52s70.23,19.44,89.07,52a8,8,0,1,0,13.85-8ZM72,96a56,56,0,1,1,56,56A56.06,56.06,0,0,1,72,96Z"></path>
            </svg>
          </div>
        </button>
      </div>
    </div>
    <div class="px-4 py-3">
      <label class="flex flex-col min-w-40 h-12 w-full">
        <div class="flex w-full flex-1 items-stretch rounded-xl h-full">
          <div class="text-neutral-500 flex border-none bg-[#ededed] items-center justify-center pl-4 rounded-l-xl border-r-0" data-icon="MagnifyingGlass" data-size="24px" data-weight="regular">
            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"></path></svg>
          </div>
          <input placeholder="Search" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#141414] focus:outline-0 focus:ring-0 border-none bg-[#ededed] focus:border-none h-full placeholder:text-neutral-500 px-4 rounded-l-none border-l-0 pl-2 text-base font-normal leading-normal" />
        </div>
      </label>
    </div>

    <!-- Tabs -->
    <div class="flex gap-3 p-3 overflow-x-hidden">
      <button class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-full bg-[#2563eb] text-white pl-4 pr-2" onclick="showSection('cases')">
        <p class="text-sm font-medium leading-normal">Cases</p>
      </button>
      <button class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-full bg-[#ededed] pl-4 pr-2" onclick="showSection('proposals')">
        <p class="text-[#141414] text-sm font-medium leading-normal">Proposals</p>
      </button>
      <button class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-full bg-[#ededed] pl-4 pr-2" onclick="showSection('collaborations')">
        <p class="text-[#141414] text-sm font-medium leading-normal">Collaborations</p>
      </button>
      <button class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-full bg-[#ededed] pl-4 pr-2" onclick="showSection('studies')">
        <p class="text-[#141414] text-sm font-medium leading-normal">Studies</p>
      </button>
    </div>

    <!-- Cases Section -->
    <div id="cases-section" class="content-section">
      <h2 class="px-4 pt-5 pb-3 text-[22px] font-bold text-[#141414]">Active Cases</h2>
      <div class="p-4 space-y-3" id="cases-list">
        <!-- Cases loaded dynamically -->
      </div>
    </div>

    <!-- Surgical Proposals Section -->
    <div id="proposals-section" class="content-section hidden">
      <h2 class="px-4 pt-5 pb-3 text-[22px] font-bold text-[#141414]">Surgical Proposals</h2>
      <div class="p-4 space-y-3" id="proposals-list">
        <!-- Proposals loaded dynamically -->
      </div>
    </div>

    <!-- Collaborations Section -->
    <div id="collaborations-section" class="content-section hidden">
      <h2 class="px-4 pt-5 pb-3 text-[22px] font-bold text-[#141414]">Active Collaborations</h2>
      <div class="p-4 space-y-3" id="collaborations-list">
        <!-- Collaborations loaded dynamically -->
      </div>
    </div>

    <!-- Studies Section -->
    <div id="studies-section" class="content-section hidden">
      <h2 class="px-4 pt-5 pb-3 text-[22px] font-bold text-[#141414]">Research Studies</h2>
      <div class="p-4 space-y-3" id="studies-list">
        <!-- Studies loaded dynamically -->
      </div>
    </div>

    <!-- New Content Sections -->
    <main class="px-4 py-8 space-y-8">
      <!-- Feedback Section -->
      <section id="feedback" class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
        <h2 class="text-2xl font-bold text-[#141414] mb-4">Feedback</h2>
        <p class="text-gray-600 leading-relaxed mb-6">
          Help us improve Surgify by sharing your feedback and suggestions. Your insights are valuable in enhancing 
          the platform's functionality and user experience for the surgical community.
        </p>
        <form id="feedback-form" class="space-y-4">
          <div>
            <label for="feedback-type" class="block text-sm font-medium text-[#141414] mb-2">Feedback Type</label>
            <select id="feedback-type" name="type" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="general">General Feedback</option>
              <option value="bug">Bug Report</option>
              <option value="feature">Feature Request</option>
              <option value="usability">Usability Issue</option>
            </select>
          </div>
          <div>
            <label for="feedback-message" class="block text-sm font-medium text-[#141414] mb-2">Message</label>
            <textarea id="feedback-message" name="message" rows="4" 
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                      placeholder="Please share your feedback here..." required></textarea>
          </div>
          <div>
            <label for="feedback-email" class="block text-sm font-medium text-[#141414] mb-2">Email (Optional)</label>
            <input type="email" id="feedback-email" name="email" 
                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                   placeholder="your.email@example.com">
          </div>
          <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
            Submit Feedback
          </button>
        </form>
      </section>

      <!-- About Section -->
      <section id="about" class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
        <h2 class="text-2xl font-bold text-[#141414] mb-4">About Surgify</h2>
        <div class="space-y-4 text-gray-600 leading-relaxed">
          <p>
            Surgify is a cutting-edge clinical research platform designed to revolutionize surgical decision-making. 
            Our platform combines advanced analytics, real-time data processing, and evidence-based protocols to 
            support healthcare professionals in delivering optimal patient outcomes.
          </p>
          <p>
            With a focus on gastric and oncological procedures, Surgify provides comprehensive tools for case management, 
            protocol adherence, and continuous learning through our extensive medical literature database.
          </p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
            <div>
              <h3 class="font-semibold text-[#141414] mb-2">Key Features</h3>
              <ul class="space-y-1 text-sm">
                <li>• Real-time collaboration tools</li>
                <li>• Evidence-based decision support</li>
                <li>• Comprehensive case management</li>
                <li>• Advanced analytics dashboard</li>
              </ul>
            </div>
            <div>
              <h3 class="font-semibold text-[#141414] mb-2">Platform Goals</h3>
              <ul class="space-y-1 text-sm">
                <li>• Improve surgical outcomes</li>
                <li>• Enhance patient safety</li>
                <li>• Facilitate research collaboration</li>
                <li>• Support clinical excellence</li>
              </ul>
            </div>
          </div>
        </div>
      </section>

      <!-- Partners Section -->
      <section id="partners" class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
        <h2 class="text-2xl font-bold text-[#141414] mb-4">Our Partners</h2>
        <p class="text-gray-600 leading-relaxed mb-6">
          Surgify collaborates with leading medical institutions, research centers, and healthcare technology 
          companies worldwide to advance surgical excellence and patient safety.
        </p>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <article class="flex items-center space-x-3">
            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#2563eb" viewBox="0 0 256 256">
                <path d="M224,48H32A16,16,0,0,0,16,64V192a16,16,0,0,0,16,16H224a16,16,0,0,0,16-16V64A16,16,0,0,0,224,48ZM32,192V64H224V192Z"></path>
              </svg>
            </div>
            <div>
              <h3 class="font-semibold text-[#141414]">Medical Research Centers</h3>
              <p class="text-sm text-gray-500">Leading academic institutions</p>
            </div>
          </article>
          <article class="flex items-center space-x-3">
            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#10b981" viewBox="0 0 256 256">
                <path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Z"></path>
              </svg>
            </div>
            <div>
              <h3 class="font-semibold text-[#141414]">Healthcare Systems</h3>
              <p class="text-sm text-gray-500">Global hospital networks</p>
            </div>
          </article>
          <article class="flex items-center space-x-3">
            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#7c3aed" viewBox="0 0 256 256">
                <path d="M208,80H176V56a48,48,0,0,0-96,0V80H48A16,16,0,0,0,32,96V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V96A16,16,0,0,0,208,80Z"></path>
              </svg>
            </div>
            <div>
              <h3 class="font-semibold text-[#141414]">Technology Partners</h3>
              <p class="text-sm text-gray-500">Innovation & security solutions</p>
            </div>
          </article>
        </div>
      </section>

      <!-- Terms & Conditions Section -->
      <section id="terms" class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
        <h2 class="text-2xl font-bold text-[#141414] mb-4">Terms & Conditions</h2>
        <div class="space-y-4 text-gray-600">
          <article>
            <h3 class="font-semibold text-[#141414] mb-2">Privacy & Data Security</h3>
            <p class="leading-relaxed">
              All patient data and clinical information processed through Surgify is encrypted and complies with 
              HIPAA, GDPR, and other applicable healthcare data protection regulations. We implement robust 
              security measures to protect sensitive medical information.
            </p>
          </article>
          
          <article>
            <h3 class="font-semibold text-[#141414] mb-2">Clinical Use</h3>
            <p class="leading-relaxed">
              Surgify is designed as a decision support tool and should be used in conjunction with professional 
              medical judgment. Final clinical decisions remain the responsibility of the healthcare provider. 
              This platform does not replace clinical expertise or medical training.
            </p>
          </article>
          
          <article>
            <h3 class="font-semibold text-[#141414] mb-2">Licensing & Access</h3>
            <p class="leading-relaxed">
              Use of this platform is subject to institutional licensing agreements. Unauthorized access or 
              distribution of platform content is strictly prohibited. Access is granted on a per-institution 
              basis with appropriate verification.
            </p>
          </article>
          
          <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
            <p class="text-sm text-blue-800">
              <strong>Important:</strong> For complete terms and conditions, please contact your system administrator 
              or visit our legal documentation center. These terms are subject to periodic updates.
            </p>
          </div>
        </div>
      </section>
    </main>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Enhanced Surgify App with Collaboration Features
const surgifyApp = {
    currentTab: 'journal',
    currentCaseId: null,
    darkMode: false,
    
    init() {
        console.log('Surgify collaboration app initialized');
        this.bindEvents();
        this.loadInitialData();
        this.setupTheme();
        this.setupRealtimeUpdates();
        this.setupFeedbackForm();
    },
    
    bindEvents() {
        // Tab switching
        document.querySelectorAll('[data-tab]').forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                this.switchTab(e.target.closest('[data-tab]').dataset.tab);
            });
        });
        
        // Theme toggle
        const themeToggle = document.getElementById('theme-toggle');
        if (themeToggle) {
            themeToggle.addEventListener('click', this.toggleTheme.bind(this));
        }
        
        // Case and proposal interactions
        document.addEventListener('click', (e) => {
            if (e.target.closest('[data-case-id]')) {
                const caseId = e.target.closest('[data-case-id]').dataset.caseId;
                this.selectCase(caseId);
            }
            
            if (e.target.matches('[data-action="create-proposal"]')) {
                e.preventDefault();
                this.createProposal(e.target.dataset.caseId);
            }
            
            if (e.target.matches('[data-action="approve-proposal"]')) {
                e.preventDefault();
                this.approveProposal(e.target.dataset.proposalId);
            }
        });
    },
    
    setupTheme() {
        const savedTheme = localStorage.getItem('surgify-theme');
        if (savedTheme === 'dark') {
            this.enableDarkMode();
        }
    },
    
    toggleTheme() {
        if (this.darkMode) {
            this.disableDarkMode();
        } else {
            this.enableDarkMode();
        }
    },
    
    enableDarkMode() {
        this.darkMode = true;
        document.documentElement.classList.add('dark');
        localStorage.setItem('surgify-theme', 'dark');
    },
    
    disableDarkMode() {
        this.darkMode = false;
        document.documentElement.classList.remove('dark');
        localStorage.setItem('surgify-theme', 'light');
    },
    
    async loadInitialData() {
        try {
            // Enhanced data loading for collaboration features
            const [cases, proposals] = await Promise.all([
                this.fetchAPI('/api/v1/cases').catch(() => []),
                this.fetchAPI('/api/v1/proposals').catch(() => [])
            ]);
            
            this.renderFeaturedContent(cases, proposals);
        } catch (error) {
            console.error('Failed to load initial data:', error);
        }
    },
    
    renderFeaturedContent(cases, proposals) {
        // Add dynamic content to featured sections based on actual data
        const featuredSeries = document.querySelector('.featured-series-container');
        if (featuredSeries && cases.length > 0) {
            const caseCards = cases.slice(0, 3).map(case_ => `
                <div class="min-w-[200px] flex flex-col gap-4 rounded-lg cursor-pointer" data-case-id="${case_.id}">
                    <div class="aspect-video bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center">
                        <span class="text-white font-semibold">${case_.case_number}</span>
                    </div>
                    <p class="text-base font-medium text-[#141414]">${case_.diagnosis}</p>
                    <p class="text-sm text-neutral-500">${case_.procedure_type}</p>
                </div>
            `).join('');
            
            featuredSeries.innerHTML = caseCards;
        }
    },
    
    switchTab(tabName) {
        this.currentTab = tabName;
        
        // Update active tab styling
        document.querySelectorAll('[data-tab]').forEach(tab => {
            const button = tab.querySelector('button') || tab;
            button.classList.remove('bg-[#ededed]');
            if (tab.dataset.tab === tabName) {
                button.classList.add('bg-[#ededed]');
            }
        });
        
        // Load tab-specific content
        this.loadTabContent(tabName);
    },
    
    async loadTabContent(tabName) {
        const mainContent = document.querySelector('.main-content-area');
        if (!mainContent) return;
        
        try {
            switch(tabName) {
                case 'cases':
                    await this.loadCasesTab();
                    break;
                case 'proposals':
                    await this.loadProposalsTab();
                    break;
                case 'studies':
                    await this.loadStudiesTab();
                    break;
                default:
                    // Keep existing journal content
                    break;
            }
        } catch (error) {
            console.error(`Failed to load ${tabName} content:`, error);
        }
    },
    
    async loadCasesTab() {
        try {
            const cases = await this.fetchAPI('/api/v1/cases');
            this.updateMainContent('Active Surgical Cases', cases.map(case_ => `
                <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 mb-4" data-case-id="${case_.id}">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-bold text-[#141414]">${case_.case_number}</h3>
                        <span class="text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-800">${case_.status}</span>
                    </div>
                    <p class="text-sm text-neutral-600 mb-2">${case_.diagnosis}</p>
                    <p class="text-xs text-neutral-500 mb-3">Procedure: ${case_.procedure_type}</p>
                    <div class="flex gap-2">
                        <button class="text-xs bg-blue-500 text-white px-3 py-1 rounded-full hover:bg-blue-600" 
                                data-action="create-proposal" data-case-id="${case_.id}">
                            Create Proposal
                        </button>
                        <button class="text-xs bg-neutral-500 text-white px-3 py-1 rounded-full hover:bg-neutral-600" 
                                onclick="surgifyApp.viewCaseDetails(${case_.id})">
                            View Details
                        </button>
                    </div>
                </div>
            `).join(''));
        } catch (error) {
            this.updateMainContent('Cases', '<p class="text-neutral-500">Failed to load cases</p>');
        }
    },
    
    async loadProposalsTab() {
        try {
            const proposals = await this.fetchAPI('/api/v1/proposals');
            this.updateMainContent('Collaborative Proposals', proposals.map(proposal => `
                <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 mb-4">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-bold text-[#141414]">${proposal.title}</h3>
                        <span class="text-xs px-2 py-1 rounded-full ${this.getStatusColor(proposal.status)}">${proposal.status}</span>
                    </div>
                    <p class="text-sm text-neutral-600 mb-2">${proposal.description}</p>
                    <p class="text-xs text-neutral-500 mb-3">Study: ${proposal.study_reference || 'No study reference'}</p>
                    <div class="flex gap-2">
                        <button class="text-xs bg-green-500 text-white px-3 py-1 rounded-full hover:bg-green-600" 
                                data-action="approve-proposal" data-proposal-id="${proposal.id}">
                            Approve
                        </button>
                        <button class="text-xs bg-yellow-500 text-white px-3 py-1 rounded-full hover:bg-yellow-600" 
                                onclick="surgifyApp.reviewProposal(${proposal.id})">
                            Review
                        </button>
                    </div>
                </div>
            `).join(''));
        } catch (error) {
            this.updateMainContent('Proposals', '<p class="text-neutral-500">Failed to load proposals</p>');
        }
    },
    
    async loadStudiesTab() {
        this.updateMainContent('Research Studies', `
            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                <h3 class="font-bold text-[#141414] mb-4">ADCI Gastric Float Surgery Study</h3>
                <p class="text-sm text-neutral-600 mb-3">
                    Advanced Decision-Clinical Impact (ADCI) study analyzing gastric float surgery outcomes 
                    using our proprietary impact analyzer tool.
                </p>
                <div class="flex flex-wrap gap-2 mb-4">
                    <span class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-800">Validated</span>
                    <span class="text-xs px-2 py-1 rounded-full bg-yellow-100 text-yellow-800">Awaiting Approval</span>
                </div>
                <button class="text-xs bg-blue-500 text-white px-4 py-2 rounded-full hover:bg-blue-600">
                    View Study Details
                </button>
            </div>
        `);
    },
    
    updateMainContent(title, content) {
        const mainArea = document.querySelector('.main-content-area') || document.querySelector('.px-4.space-y-4');
        if (mainArea) {
            mainArea.innerHTML = `
                <h2 class="px-4 pt-5 pb-3 text-[22px] font-bold text-[#141414]">${title}</h2>
                <div class="px-4">${content}</div>
            `;
        }
    },
    
    async createProposal(caseId) {
        const modalHtml = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" id="proposal-modal">
                <div class="bg-white rounded-xl p-6 w-full max-w-md">
                    <h3 class="text-lg font-bold text-[#141414] mb-4">Create Surgical Proposal</h3>
                    <form id="proposal-form">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-[#141414] mb-2">Title</label>
                            <input type="text" name="title" class="w-full border border-neutral-300 rounded-lg px-3 py-2" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-[#141414] mb-2">Description</label>
                            <textarea name="description" class="w-full border border-neutral-300 rounded-lg px-3 py-2" rows="3" required></textarea>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-[#141414] mb-2">Supporting Study</label>
                            <input type="text" name="study_reference" class="w-full border border-neutral-300 rounded-lg px-3 py-2" placeholder="ADCI gastric float surgery study...">
                        </div>
                        <div class="flex gap-3">
                            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg flex-1 hover:bg-blue-600">Create</button>
                            <button type="button" onclick="surgifyApp.closeModal()" class="bg-neutral-500 text-white px-4 py-2 rounded-lg hover:bg-neutral-600">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        document.getElementById('proposal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            try {
                await this.fetchAPI('/api/v1/proposals', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        case_id: parseInt(caseId),
                        title: formData.get('title'),
                        description: formData.get('description'),
                        study_reference: formData.get('study_reference'),
                        status: 'draft'
                    })
                });
                
                this.closeModal();
                this.showNotification('Proposal created successfully', 'success');
                if (this.currentTab === 'proposals') {
                    this.loadProposalsTab();
                }
            } catch (error) {
                this.showNotification('Failed to create proposal', 'error');
            }
        });
    },
    
    async approveProposal(proposalId) {
        try {
            await this.fetchAPI(`/api/v1/proposals/${proposalId}/approve`, {
                method: 'POST'
            });
            
            this.showNotification('Proposal approved', 'success');
            if (this.currentTab === 'proposals') {
                this.loadProposalsTab();
            }
        } catch (error) {
            this.showNotification('Failed to approve proposal', 'error');
        }
    },
    
    closeModal() {
        const modal = document.getElementById('proposal-modal');
        if (modal) modal.remove();
    },
    
    getStatusColor(status) {
        const colors = {
            'draft': 'bg-neutral-100 text-neutral-800',
            'under_review': 'bg-yellow-100 text-yellow-800',
            'approved': 'bg-green-100 text-green-800',
            'rejected': 'bg-red-100 text-red-800'
        };
        return colors[status] || 'bg-neutral-100 text-neutral-800';
    },
    
    async fetchAPI(url, options = {}) {
        const response = await fetch(url, options);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    },
    
    showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 ${
            type === 'success' ? 'bg-green-500' : 
            type === 'error' ? 'bg-red-500' : 'bg-blue-500'
        }`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    },
    
    setupRealtimeUpdates() {
        // Poll for updates every 30 seconds when on collaborative tabs
        setInterval(() => {
            if (this.currentTab === 'proposals') {
                this.loadProposalsTab();
            } else if (this.currentTab === 'cases') {
                this.loadCasesTab();
            }
        }, 30000);
    },
    
    setupFeedbackForm() {
        const feedbackForm = document.getElementById('feedback-form');
        if (feedbackForm) {
            feedbackForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const feedbackData = {
                    type: formData.get('type'),
                    message: formData.get('message'),
                    email: formData.get('email') || null
                };
                
                try {
                    // For now, just show a success message
                    // In the future, this would send to an API endpoint
                    this.showNotification('Thank you for your feedback! We appreciate your input.', 'success');
                    feedbackForm.reset();
                    
                    // TODO: Implement actual API call
                    // await this.fetchAPI('/api/v1/feedback', {
                    //     method: 'POST',
                    //     headers: {'Content-Type': 'application/json'},
                    //     body: JSON.stringify(feedbackData)
                    // });
                } catch (error) {
                    this.showNotification('Failed to submit feedback. Please try again.', 'error');
                }
            });
        }
    }
};

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    surgifyApp.init();
});
</script>
{% endblock %}
